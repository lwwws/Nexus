<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Nexus</title>
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">

  <style>
    :root{
      --bg:#0b0812;
      --panel:#120e1d;
      --panel2:#0f0b18;
      --border:#2a2140;

      --text:#f2eefc;
      --muted:#b9add6;
      --muted2:#9b8fc1;

      --accent:#b58cff;
      --accent2:#7c5cff;
      --danger:#ff4d7d;

      --bubbleL:#171027;
      --bubbleR:#201238;
      --datePill:#1a1330;

      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(181,140,255,.12), transparent 55%),
        radial-gradient(900px 500px at 80% 10%, rgba(124,92,255,.10), transparent 60%),
        var(--bg);
      color:var(--text);
      height:100vh;
      overflow:hidden;
    }

    .app{ display:flex; height:100vh; }

    /* Left sidebar */
    .left{
      width:320px; min-width:280px;
      background: linear-gradient(180deg, rgba(18,14,29,.92), rgba(15,11,24,.92));
      border-right:1px solid var(--border);
      display:flex; flex-direction:column;
    }

    /* Right sidebar */
    .right{
      width:360px; min-width:320px;
      background: linear-gradient(180deg, rgba(18,14,29,.92), rgba(15,11,24,.92));
      border-left:1px solid var(--border);
      display:flex; flex-direction:column;
    }

    /* Center */
    .main{ flex:1; display:flex; flex-direction:column; min-width:420px; }

    header.panelHeader{
      padding:14px;
      border-bottom:1px solid var(--border);
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .row{ display:flex; gap:10px; align-items:center; }
    .grow{ flex:1; }

    input, select, button{
      background: rgba(10, 8, 16, .85);
      color: var(--text);
      border:1px solid var(--border);
      padding:10px 12px;
      border-radius:12px;
      outline:none;
    }

    button{ cursor:pointer; }
    button.primary{
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      border-color: transparent;
      color:#110a1f;
      font-weight:900;
      box-shadow: 0 8px 20px rgba(181,140,255,.18);
    }
    button.ghost{ background: transparent; }
    button:disabled{ opacity:.55; cursor:not-allowed; }

    .hint{ color: var(--muted); font-size:12px; line-height:1.35; }
    .error{ color: var(--danger); font-size:12px; display:none; }

    .list{ overflow:auto; padding:10px; flex:1; }
    .empty{
      color: var(--muted);
      text-align:center;
      padding:54px 14px;
      border:1px dashed rgba(42,33,64,.9);
      border-radius:16px;
      background: rgba(10,8,16,.35);
      margin:10px;
    }

    .chatCard{
      border:1px solid var(--border);
      background: rgba(10,8,16,.55);
      border-radius:16px;
      padding:12px;
      margin:10px 0;
      cursor:pointer;
      transition: transform .08s ease, border-color .08s ease;
    }
    .chatCard:hover{ border-color: rgba(181,140,255,.55); transform: translateY(-1px); }
    .chatCard.active{
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(181,140,255,.25), var(--shadow);
    }
    .chatCard .title{ font-weight:900; margin-bottom:6px; }
    .chatCard .meta{ display:flex; justify-content:space-between; color: var(--muted2); font-size:12px; }

    /* Center topbar */
    .topbar{
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      background: rgba(18,14,29,.55);
      backdrop-filter: blur(8px);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
    }
    .brand{ display:flex; flex-direction:column; gap:2px; }
    .brand .big{ font-weight:1000; letter-spacing:.5px; }
    .brand .sub{ color:var(--muted); font-size:12px; }

    .toggle{
      display:flex;
      gap:8px;
      padding:5px;
      border:1px solid var(--border);
      background: rgba(10,8,16,.45);
      border-radius:14px;
    }
    .toggle button{
      border:0;
      background: transparent;
      color: var(--muted);
      padding:8px 10px;
      border-radius:12px;
      font-weight:900;
    }
    .toggle button.active{
      background: rgba(181,140,255,.22);
      color: var(--text);
      box-shadow: inset 0 0 0 1px rgba(181,140,255,.22);
    }

    /* Messenger-like message area */
    .content{
      flex:1;
      overflow:auto;
      padding:14px 16px;
      display:flex;
      flex-direction:column;
      gap:10px;
      background: rgba(11,8,18,.20);

      /* important */
      align-items: stretch;
    }

    /* Load older bar sits at top */
    .loadOlderWrap{
      display:flex;
      justify-content:center;
      padding:6px 0 2px 0;
    }

    /* Date separator */
    .dateSep{
      display:flex;
      justify-content:center;
      padding:10px 0 4px 0;
    }
    .datePill{
      font-size:12px;
      color: var(--muted);
      padding:6px 12px;
      border-radius:999px;
      border:1px solid rgba(42,33,64,.9);
      background: rgba(26,19,48,.55);
      backdrop-filter: blur(6px);
    }

    /* System/group notification (no bubble, centered) */
    .sys{
      display:flex;
      justify-content:center;
      padding:8px 0;
      color: var(--muted2);
      font-size:13px;
      text-align:center;
    }
    .sys .sysText{
      max-width: 82%;
      line-height:1.3;
      padding:6px 10px;
      border-radius:12px;
      background: rgba(10,8,16,.30);
      border:1px dashed rgba(42,33,64,.7);
    }

    /* Message bubbles */
    .msgRow{
      display:flex;
      justify-content:flex-start;
      width: 100%;
    }
    .msgRow.left{ justify-content:flex-start; }
    .msgRow.right{ justify-content:flex-end; }

    .bubble{
      display: inline-block;

      /* key fix */
      width: fit-content;
      max-width: min(78%, 720px);
      min-width: 120px;

      border:1px solid rgba(42,33,64,.9);
      border-radius:16px;
      padding:2px 12px;
      background: linear-gradient(180deg, rgba(23,16,39,.94), rgba(16,11,28,.90));
      box-shadow: 0 8px 18px rgba(0,0,0,.18);

      white-space:pre-wrap;
      word-break:break-word;
      line-height:1.25;
    }

    .bubble.right{
      background: linear-gradient(180deg, rgba(32,18,56,.94), rgba(16,11,28,.90));
    }

    .bubble .text{
      margin-top: 4px;
    }

    .metaLine{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-bottom:6px;
      font-size:12px;
      color: var(--muted);
    }

    .name{
      font-weight:900;
      max-width: 95%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .time{
      display:flex;
      gap:8px;
      align-items:center;
      color: var(--muted2);
      white-space:nowrap;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:2px 10px;
      border-radius:999px;
      border:1px solid rgba(42,33,64,.9);
      background: rgba(10,8,16,.45);
      color: var(--muted);
      font-size:11px;
      max-width: 240px;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* Composer */
    .composer{
      padding:12px;
      border-top:1px solid var(--border);
      background: rgba(18,14,29,.80);
      display:flex;
      gap:10px;
      align-items:center;
    }
    .composer input{ flex:1; }

    /* Topics (right) */
    .topicCard{
      border:1px solid var(--border);
      background: rgba(10,8,16,.55);
      border-radius:16px;
      padding:12px;
      margin:10px 0;
    }
    .topicCard.active{
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(181,140,255,.22);
    }
    .topicTop{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
    }
    .topicTitle{ font-weight:950; line-height:1.15; }
    .topicMeta{ color: var(--muted2); font-size:12px; margin-top:4px; }
    details summary{
      cursor:pointer;
      color: var(--muted);
      margin-top:10px;
      user-select:none;
    }
    details .summaryBox{
      margin-top:8px;
      padding:10px;
      border-radius:14px;
      border:1px solid rgba(42,33,64,.9);
      background: rgba(10,8,16,.35);
      color: var(--text);
      font-size:13px;
      line-height:1.35;
      white-space: pre-wrap;
    }

    /* Custom file picker */
    .filePicker{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .fileBtn{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(42,33,64,.9);
      background: rgba(10,8,16,.55);
      cursor:pointer;
      user-select:none;
      transition: border-color .08s ease, transform .08s ease;
      width: 100%;
      justify-content:space-between;
    }
    .fileBtn:hover{
      border-color: rgba(181,140,255,.6);
      transform: translateY(-1px);
    }
    .fileBtn .leftPart{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .fileIcon{
      width:34px; height:34px;
      border-radius:12px;
      background: linear-gradient(135deg, rgba(181,140,255,.25), rgba(124,92,255,.20));
      border:1px solid rgba(181,140,255,.25);
      display:flex; align-items:center; justify-content:center;
      font-weight:1000;
      color: var(--accent);
      flex:0 0 auto;
    }
    .fileName{
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      color: var(--muted);
      font-size:13px;
    }

    /* Upload overlay */
    .overlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
    }
    .modal{
      width: min(720px, 96vw);
      border-radius:18px;
      border:1px solid var(--border);
      background: rgba(18,14,29,.92);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHeader{
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .modalHeader .title{ font-weight:1000; }
    .modalBody{ padding:14px 16px; }
    .barWrap{
      border:1px solid rgba(42,33,64,.9);
      background: rgba(10,8,16,.55);
      border-radius:999px;
      overflow:hidden;
      height:14px;
      margin-top:10px;
    }
    .bar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
    }

    /* Context modal */
    .ctxBackdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center; padding:16px;
    }
    .ctxModal{
      width:min(820px, 100%);
      max-height:min(82vh, 950px);
      background: rgba(18,14,29,.96);
      border:1px solid var(--border);
      border-radius:18px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      box-shadow: var(--shadow);
    }
    .ctxModal header{
      padding:12px 14px;
      border-bottom:1px solid var(--border);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .ctxBody{ padding:14px; overflow:auto; }
    .ctxTarget{
      border-color: var(--accent) !important;
      box-shadow: 0 0 0 1px rgba(181,140,255,.22);
    }

    /* Gap button in focus mode */
    .gapWrap{
      display:flex;
      justify-content:center;
      padding:6px 0;
    }
    .gapBtn{
      font-size:12px;
      padding:8px 12px;
      border-radius:999px;
    }
  </style>
</head>

<body>
<div class="app">

  <!-- LEFT: Chats -->
  <aside class="left">
    <header class="panelHeader">

      <input id="fileInput" type="file" accept=".txt" style="display:none"/>

      <div class="filePicker">
        <div id="fileBtn" class="fileBtn">
          <div class="leftPart">
            <div class="fileIcon">W</div>
            <div class="fileName" id="fileName">Choose WhatsApp export (.txt)</div>
          </div>
          <div style="color:var(--muted2); font-weight:900;">Browse</div>
        </div>
      </div>

      <div class="row">
        <button id="uploadBtn" class="primary grow">Upload & Disentangle</button>
      </div>

      <div class="hint">
        Left: chats • Right: topics • Center: WhatsApp-like view (newest at bottom).
      </div>

      <div id="leftError" class="error"></div>
    </header>

    <div class="list" id="chatList">
      <div class="empty">No chats uploaded yet.</div>
    </div>
  </aside>

  <!-- CENTER: Messages -->
  <main class="main">
    <div class="topbar">
      <div class="brand">
        <div class="big" id="centerTitle">Nexus</div>
        <div class="sub" id="centerSub">Upload a chat to begin.</div>
      </div>

      <div class="toggle">
        <button id="modeFocus" class="active">Focus</button>
        <button id="modeTimeline">Timeline</button>
      </div>
    </div>

    <div class="content" id="content">
      <div class="empty">Upload a chat export (.txt) to start.</div>
    </div>

    <div class="composer">
      <select id="userSelect" style="width:180px;">
        <option value="">Pick user…</option>
      </select>
      <input id="msgInput" placeholder="Type a message… (Enter to send)"/>
      <button id="sendBtn" class="primary">Send</button>
    </div>
  </main>

  <!-- RIGHT: Topics -->
  <aside class="right">
    <header class="panelHeader">
      <div class="row">
        <input id="topicSearch" class="grow" placeholder="Filter topics…"/>
      </div>
      <div class="hint" id="rightHint">Topics appear after processing.</div>
      <div id="rightError" class="error"></div>
    </header>

    <div class="list" id="topicList">
      <div class="empty">No topics yet.</div>
    </div>
  </aside>

</div>

<!-- Upload overlay -->
<div class="overlay" id="overlay">
  <div class="modal">
    <div class="modalHeader">
      <div class="title">Processing…</div>
      <button id="closeOverlay" class="ghost" disabled>Close</button>
    </div>
    <div class="modalBody">
      <div class="hint" id="jobStage">Starting…</div>
      <div class="barWrap"><div class="bar" id="jobBar"></div></div>
      <div class="hint" style="margin-top:10px;" id="jobDetail"></div>
      <div class="error" id="jobError" style="display:none;"></div>
    </div>
  </div>
</div>

<!-- Context modal -->
<div class="ctxBackdrop" id="ctxBackdrop" role="dialog" aria-modal="true">
  <div class="ctxModal">
    <header>
      <div style="font-weight:1000;">Message Context</div>
      <button id="closeCtx" class="ghost">Close</button>
    </header>
    <div class="ctxBody" id="ctxBody"></div>
  </div>
</div>

<script>
  const state = {
    activeChatId: null,
    activeChatName: null,

    mode: "focus",
    activeTopicId: null,

    // Timeline paging (from the bottom)
    timelineLimit: 80,
    timelineOffset: 0,
    timelineMessages: [],
    timelineHasMore: false,

    // Focus gaps expansion: key "a|b" -> array of messages between
    expandedBetween: {},

    cachedTopics: [],
    cachedChats: [],
  };

  function $(id){ return document.getElementById(id); }

  function esc(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  async function apiGet(url){
    const res = await fetch(url);
    if(!res.ok){
      const t = await res.text().catch(()=> "");
      throw new Error(`${res.status} ${res.statusText}${t ? " — " + t : ""}`);
    }
    return res.json();
  }

  async function apiPost(url, body){
    const res = await fetch(url, {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(body)
    });
    if(!res.ok){
      const t = await res.text().catch(()=> "");
      throw new Error(`${res.status} ${res.statusText}${t ? " — " + t : ""}`);
    }
    return res.json();
  }

  function setLeftError(msg){
    const el = $("leftError");
    if(!msg){ el.style.display="none"; el.textContent=""; return; }
    el.style.display="block";
    el.textContent = msg;
  }
  function setRightError(msg){
    const el = $("rightError");
    if(!msg){ el.style.display="none"; el.textContent=""; return; }
    el.style.display="block";
    el.textContent = msg;
  }

  function setCenter(title, sub){
    $("centerTitle").textContent = title || "Nexus";
    $("centerSub").textContent = sub || "";
  }

  function showOverlay(show){ $("overlay").style.display = show ? "flex" : "none"; }
  function setJobUI({stage, progress, detail, error, status}){
    $("jobStage").textContent = stage || "";
    $("jobDetail").textContent = detail || "";
    $("jobBar").style.width = `${Math.max(0, Math.min(100, progress || 0))}%`;
    if(error){
      $("jobError").style.display = "block";
      $("jobError").textContent = error;
    } else {
      $("jobError").style.display = "none";
      $("jobError").textContent = "";
    }
    $("closeOverlay").disabled = !(status === "done" || status === "error");
  }

  // Deterministic color per user name (WhatsApp-like)
  function userColor(name){
    if(!name) return "var(--text)";
    let h = 0;
    for(let i=0;i<name.length;i++){
      h = (h*31 + name.charCodeAt(i)) >>> 0;
    }
    // map to hue range with decent contrast
    const hue = (h % 280) + 40;
    return `hsl(${hue} 85% 72%)`;
  }

  function formatDateLabel(iso){
    const d = new Date(iso);
    const opts = { year: "numeric", month: "short", day: "numeric" };
    return d.toLocaleDateString(undefined, opts);
  }

  function formatTime(iso){
    const d = new Date(iso);
    return d.toLocaleTimeString(undefined, {hour:"2-digit", minute:"2-digit"});
  }

  // -----------------------------
  // LEFT: chats
  // -----------------------------
  function renderChats(chats){
    const box = $("chatList");
    if(!chats || chats.length === 0){
      box.innerHTML = `<div class="empty">No chats uploaded yet.</div>`;
      return;
    }

    box.innerHTML = chats.map(c => {
      const active = (c.chat_id === state.activeChatId) ? "active" : "";
      const metaL = c.is_ready ? `${c.topic_count} topics` : "Processing…";
      const metaR = c.message_count ? `${c.message_count} msgs` : "";
      return `
        <div class="chatCard ${active}" data-chat="${esc(c.chat_id)}" data-name="${esc(c.name)}">
          <div class="title">${esc(c.name)}</div>
          <div class="meta"><span>${esc(metaL)}</span><span>${esc(metaR)}</span></div>
        </div>
      `;
    }).join("");

    box.onclick = (e) => {
      const card = e.target.closest(".chatCard");
      if(!card) return;
      selectChat(card.getAttribute("data-chat"), card.getAttribute("data-name"));
    };
  }

  async function loadChats(){
    const chats = await apiGet("/api/chats");
    state.cachedChats = chats;
    renderChats(chats);
  }

  // -----------------------------
  // RIGHT: topics
  // -----------------------------
  function renderTopics(topics){
    const box = $("topicList");
    if(!topics || topics.length === 0){
      box.innerHTML = `<div class="empty">No topics yet.</div>`;
      return;
    }

    box.innerHTML = topics.map(t => {
      const active = (t.id === state.activeTopicId) ? "active" : "";
      return `
        <div class="topicCard ${active}">
          <div class="topicTop">
            <div style="min-width:0;">
              <div class="topicTitle">${esc(t.title || "Untitled topic")}</div>
              <div class="topicMeta">${esc(t.message_count || 0)} messages</div>
            </div>
            <button class="primary" data-topic="${esc(t.id)}" style="padding:8px 10px; border-radius:14px;">
              Focus
            </button>
          </div>

          <details>
            <summary>Summary</summary>
            <div class="summaryBox">${esc(t.summary || "Summary not available.")}</div>
          </details>
        </div>
      `;
    }).join("");

    box.querySelectorAll("button[data-topic]").forEach(btn => {
      btn.onclick = () => {
        state.activeTopicId = btn.getAttribute("data-topic");
        state.expandedBetween = {};
        setMode("focus");
      };
    });
  }

  async function loadTopics(){
    setRightError("");
    if(!state.activeChatId){
      renderTopics([]);
      return;
    }
    const topics = await apiGet(`/api/chats/${encodeURIComponent(state.activeChatId)}/topics`);
    state.cachedTopics = topics;
    $("rightHint").textContent = topics.length ? "Topics" : "Topics appear after processing.";
    filterTopics();
  }

  function filterTopics(){
    const q = $("topicSearch").value.trim().toLowerCase();
    if(!q){
      renderTopics(state.cachedTopics);
      return;
    }
    const filtered = state.cachedTopics.filter(t =>
      String(t.title || "").toLowerCase().includes(q) ||
      String(t.summary || "").toLowerCase().includes(q)
    );
    renderTopics(filtered);
  }

  // -----------------------------
  // Users dropdown
  // -----------------------------
  async function loadUsers(){
    if(!state.activeChatId){
      $("userSelect").innerHTML = `<option value="">Pick user…</option>`;
      return;
    }
    const users = await apiGet(`/api/chats/${encodeURIComponent(state.activeChatId)}/users`);
    $("userSelect").innerHTML =
      `<option value="">Pick user…</option>` +
      users.map(u => `<option value="${esc(u)}">${esc(u)}</option>`).join("");
  }

  // -----------------------------
  // Render messages WhatsApp-like:
  // - chronological order
  // - date separators
  // - system notifications centered
  // - name color per user
  // - newest at bottom (scroll down)
  // -----------------------------
  function renderMessageList(messages, opts){
    const {
      showTopicPills=false,
      alignment="auto", // "auto" uses left for all; timeline often uses left; you can customize later
      prependLoadOlder=false,
      loadOlderHandler=null,
    } = (opts || {});

    if(!messages || messages.length === 0){
      $("content").innerHTML = `<div class="empty">No messages.</div>`;
      return;
    }

    let html = "";

    if(prependLoadOlder){
      html += `<div class="loadOlderWrap">
        <button id="loadOlderBtn" class="ghost">Load earlier messages</button>
      </div>`;
    }

    let lastDate = null;

    for(const m of messages){
      const day = formatDateLabel(m.timestamp);
      if(day !== lastDate){
        lastDate = day;
        html += `<div class="dateSep"><div class="datePill">${esc(day)}</div></div>`;
      }

      if(m.is_system){
        html += `
          <div class="sys">
            <div class="sysText">${esc(m.text)}</div>
          </div>
        `;
        continue;
      }

      const time = formatTime(m.timestamp);
      const nameCol = userColor(m.user);

      const pill = (showTopicPills && m.thread_title)
        ? `<span class="pill"># ${esc(m.thread_title)}</span>`
        : "";

      // For now, all messages are left-aligned like group chats; you can later align "my user" to right.
      const side = "left";

      html += `
        <div class="msgRow ${side}">
          <div class="bubble ${side === "right" ? "right" : ""}">
            <div class="metaLine">
              <div style="display:flex; align-items:center; gap:8px; min-width:0;">
                ${pill}
                <span class="name" style="color:${esc(nameCol)}">${esc(m.user)}</span>
              </div>
              <div class="time">
                <button class="ghost" data-mid="${esc(m.id)}" style="padding:6px 10px;">Context</button>
                <span>${esc(time)}</span>
              </div>
            </div>
            <div class="text">${esc(m.text)}</div>
          </div>
        </div>
      `;
    }

    $("content").innerHTML = html;

    if(prependLoadOlder){
      const btn = $("loadOlderBtn");
      if(btn) btn.onclick = loadOlderHandler;
    }

    $("content").querySelectorAll("button[data-mid]").forEach(btn => {
      btn.onclick = () => openContext(btn.getAttribute("data-mid"));
    });
  }

  function scrollToBottom(){
    const c = $("content");
    c.scrollTop = c.scrollHeight;
  }

  // -----------------------------
  // Timeline mode (from bottom)
  // -----------------------------
  async function loadTimeline(reset){
    if(!state.activeChatId) return;

    if(reset){
      state.timelineOffset = 0;
      state.timelineMessages = [];
    }

    const beforeHeight = $("content").scrollHeight;
    const beforeTop = $("content").scrollTop;

    const data = await apiGet(`/api/chats/${encodeURIComponent(state.activeChatId)}/history?limit=${state.timelineLimit}&offset=${state.timelineOffset}`);
    state.timelineHasMore = !!data.has_more;

    // New chunk is older or latest depending on offset:
    // offset=0 => latest chunk. offset>0 => older chunk.
    if(state.timelineOffset === 0){
      state.timelineMessages = data.messages;
    } else {
      // prepend older messages
      state.timelineMessages = data.messages.concat(state.timelineMessages);
    }

    state.timelineOffset = data.next_offset;

    renderMessageList(state.timelineMessages, {
      showTopicPills:true,
      prependLoadOlder: state.timelineHasMore,
      loadOlderHandler: async () => {
        // preserve scroll position when prepending older chunk
        const oldScrollHeight = $("content").scrollHeight;
        await loadTimeline(false);
        const newScrollHeight = $("content").scrollHeight;
        $("content").scrollTop = (newScrollHeight - oldScrollHeight) + beforeTop;
      }
    });

    setCenter(state.activeChatName || "Chat", `Timeline • newest at bottom`);
    if(reset) scrollToBottom();
  }

  // -----------------------------
  // Focus mode with gap expansion
  // -----------------------------
  async function loadFocus(topicId){
    if(!state.activeChatId) return;

    const data = await apiGet(`/api/chats/${encodeURIComponent(state.activeChatId)}/focus/${encodeURIComponent(topicId)}`);
    const topic = data.topic || {};
    const focus = data.focus || [];

    setCenter(state.activeChatName || "Chat", `Focus • ${topic.title || "Topic"} • ${focus.length} messages`);

    // Build rendered list: focus messages plus any expanded "between" blocks.
    // We render in timeline order and insert gap buttons where needed.
    const items = [];

    let lastDate = null;
    function pushDateIfNeeded(ts){
      const day = formatDateLabel(ts);
      if(day !== lastDate){
        lastDate = day;
        items.push({type:"date", label: day});
      }
    }

    for(let i=0;i<focus.length;i++){
      const m = focus[i];
      pushDateIfNeeded(m.timestamp);
      items.push({type:"msg", msg:m});

      if(i < focus.length - 1){
        const a = focus[i];
        const b = focus[i+1];
        const gap = (b.idx - a.idx) - 1;
        if(gap > 0){
          const key = `${a.id}|${b.id}`;
          const expanded = state.expandedBetween[key];

          if(expanded && expanded.length){
            // Insert the expanded messages (with their own date separators)
            for(const x of expanded){
              pushDateIfNeeded(x.timestamp);
              items.push({type:"msg", msg:x, dim:true});
            }
          } else {
            items.push({type:"gap", from:a.id, to:b.id, count:gap});
          }
        }
      }
    }

    // Render items
    let html = "";
    for(const it of items){
      if(it.type === "date"){
        html += `<div class="dateSep"><div class="datePill">${esc(it.label)}</div></div>`;
        continue;
      }
      if(it.type === "gap"){
        html += `
          <div class="gapWrap">
            <button class="gapBtn ghost" data-gap-from="${esc(it.from)}" data-gap-to="${esc(it.to)}">
              Uncollapse ${esc(it.count)} messages between
            </button>
          </div>
        `;
        continue;
      }

      const m = it.msg;
      if(m.is_system){
        html += `
          <div class="sys">
            <div class="sysText">${esc(m.text)}</div>
          </div>
        `;
        continue;
      }

      const time = formatTime(m.timestamp);
      const nameCol = userColor(m.user);
      const side = "left";

      html += `
        <div class="msgRow ${side}">
          <div class="bubble ${side === "right" ? "right" : ""}" style="${it.dim ? "opacity:.6;" : ""}">
            <div class="metaLine">
              <div style="display:flex; align-items:center; gap:8px; min-width:0;">
                <span class="name" style="color:${esc(nameCol)}">${esc(m.user)}</span>
              </div>
              <div class="time">
                <button class="ghost" data-mid="${esc(m.id)}" style="padding:6px 10px;">Context</button>
                <span>${esc(time)}</span>
              </div>
            </div>
            <div class="text">${esc(m.text)}</div>
          </div>
        </div>
      `;
    }

    $("content").innerHTML = html;

    // Wire context buttons
    $("content").querySelectorAll("button[data-mid]").forEach(btn => {
      btn.onclick = () => openContext(btn.getAttribute("data-mid"));
    });

    // Wire gap buttons
    $("content").querySelectorAll("button[data-gap-from]").forEach(btn => {
      btn.onclick = async () => {
        const from = btn.getAttribute("data-gap-from");
        const to = btn.getAttribute("data-gap-to");
        const key = `${from}|${to}`;
        const res = await apiGet(`/api/chats/${encodeURIComponent(state.activeChatId)}/between?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}`);
        state.expandedBetween[key] = res.messages || [];
        await loadFocus(state.activeTopicId);
      };
    });

    await loadTopics(); // to refresh active highlight
    scrollToBottom();
  }

  // -----------------------------
  // Mode switching
  // -----------------------------
  function setMode(mode){
    state.mode = mode;
    $("modeFocus").classList.toggle("active", mode === "focus");
    $("modeTimeline").classList.toggle("active", mode === "timeline");

    if(!state.activeChatId){
      $("content").innerHTML = `<div class="empty">Upload a chat export (.txt) to start.</div>`;
      setCenter("Nexus", "Upload a chat to begin.");
      return;
    }

    if(mode === "timeline"){
      loadTimeline(true);
    } else {
      if(state.activeTopicId){
        loadFocus(state.activeTopicId);
      } else {
        $("content").innerHTML = `<div class="empty">Pick a topic on the right to enter Focus Mode.</div>`;
        setCenter(state.activeChatName || "Chat", "Pick a topic → only its messages will be shown.");
      }
    }
  }

  // -----------------------------
  // Selecting a chat
  // -----------------------------
  async function selectChat(chatId, name){
    state.activeChatId = chatId;
    state.activeChatName = name;
    state.activeTopicId = null;
    state.expandedBetween = {};

    // Fix highlight bug by re-rendering chat list with new active id
    renderChats(state.cachedChats);

    setCenter(name || "Chat", "Loading…");
    await loadTopics();
    await loadUsers();

    // Default view: focus
    setMode("focus");
  }

  // -----------------------------
  // Upload with progress polling
  // -----------------------------
  async function uploadChat(){
    setLeftError("");
    const file = $("fileInput").files[0];
    if(!file){
      setLeftError("Choose a WhatsApp .txt export first.");
      return;
    }

    $("uploadBtn").disabled = true;
    showOverlay(true);
    setJobUI({stage:"Uploading…", progress:1, detail:"", error:null, status:"running"});

    try{
      const fd = new FormData();
      fd.append("file", file);

      const res = await fetch("/api/chats/upload", { method:"POST", body: fd });
      if(!res.ok){
        const t = await res.text().catch(()=> "");
        throw new Error(`${res.status} ${res.statusText}${t ? " — " + t : ""}`);
      }
      const data = await res.json();

      const jobId = data.job_id;
      const chatId = data.chat_id;

      // Poll
      let done = false;
      while(!done){
        const j = await apiGet(`/api/jobs/${encodeURIComponent(jobId)}`);
        setJobUI(j);
        if(j.status === "done" || j.status === "error"){
          done = true;
          break;
        }
        await new Promise(r => setTimeout(r, 250));
      }

      await loadChats();

      // Auto-select new chat
      const newChat = state.cachedChats.find(c => c.chat_id === chatId);
      if(newChat){
        await selectChat(newChat.chat_id, newChat.name);
      }

    } catch(err){
      setJobUI({stage:"Upload failed", progress:0, detail:"", error: err.message, status:"error"});
      setLeftError(err.message);
    } finally {
      $("uploadBtn").disabled = false;
    }
  }

  // -----------------------------
  // Append message
  // -----------------------------
  async function sendMessage(){
    if(!state.activeChatId){
      alert("Pick a chat first.");
      return;
    }
    const user = $("userSelect").value;
    const text = $("msgInput").value; // keep newlines
    if(!user){ alert("Pick a user."); return; }
    if(!text.trim()) return;

    $("sendBtn").disabled = true;
    try{
      await apiPost(`/api/chats/${encodeURIComponent(state.activeChatId)}/message`, { user, text });
      $("msgInput").value = "";

      await loadTopics();

      if(state.mode === "timeline"){
        // Reload the latest window (newest at bottom)
        await loadTimeline(true);
      } else {
        if(state.activeTopicId){
          await loadFocus(state.activeTopicId);
        }
      }
    } catch(err){
      alert("Send failed: " + err.message);
    } finally {
      $("sendBtn").disabled = false;
    }
  }

  // -----------------------------
  // Context modal
  // -----------------------------
  function openCtx(html){
    $("ctxBody").innerHTML = html;
    $("ctxBackdrop").style.display = "flex";
  }
  function closeCtx(){
    $("ctxBackdrop").style.display = "none";
    $("ctxBody").innerHTML = "";
  }

  async function openContext(messageId){
    if(!state.activeChatId) return;
    try{
      const ctx = await apiGet(`/api/chats/${encodeURIComponent(state.activeChatId)}/context/${encodeURIComponent(messageId)}?window=4`);
      const html = ctx.map(m => {
        const cls = m.is_target ? "bubble ctxTarget" : "bubble";
        const time = formatTime(m.timestamp);
        if(m.is_system){
          return `<div class="sys"><div class="sysText">${esc(m.text)}</div></div>`;
        }
        return `
          <div class="${cls}" style="max-width:100%; margin:10px 0;">
            <div class="metaLine">
              <div><span class="name" style="color:${esc(userColor(m.user))}">${esc(m.user)}</span></div>
              <div class="time"><span>${esc(time)}</span></div>
            </div>
            <div class="text">${esc(m.text)}</div>
          </div>
        `;
      }).join("");
      openCtx(html);
    } catch(err){
      openCtx(`<div class="empty">Failed to load context: ${esc(err.message)}</div>`);
    }
  }

  // -----------------------------
  // Wire up
  // -----------------------------
  $("modeFocus").onclick = () => setMode("focus");
  $("modeTimeline").onclick = () => setMode("timeline");
  $("topicSearch").addEventListener("input", filterTopics);

  $("sendBtn").onclick = sendMessage;
  $("msgInput").addEventListener("keydown", (e)=> { if(e.key==="Enter" && !e.shiftKey) { e.preventDefault(); sendMessage(); } });

  $("closeCtx").onclick = closeCtx;
  $("ctxBackdrop").addEventListener("click", (e)=> { if(e.target === $("ctxBackdrop")) closeCtx(); });
  document.addEventListener("keydown", (e)=> { if(e.key==="Escape") closeCtx(); });

  $("closeOverlay").onclick = () => showOverlay(false);

  // Custom file picker
  $("fileBtn").onclick = () => $("fileInput").click();
  $("fileInput").addEventListener("change", () => {
    const f = $("fileInput").files[0];
    $("fileName").textContent = f ? f.name : "Choose WhatsApp export (.txt)";
  });

  $("uploadBtn").onclick = uploadChat;

  // Init
  (async function init(){
    await loadChats();
  })();
</script>
</body>
</html>
